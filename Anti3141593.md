# 1. Introduction #

Микро-проект для противодействия удалению рабочих файлов увольняющимися сотрудниками.

# 2. Details #
  * Небольшая сеть (15 машин Windows)
  * LAN via WiFi
  * Домен на AD
  * Профили - локально

# 3. Task #

Сделать так, чтобы увольняющиеся сотрудники не могли безвозвратно уничтожить данные. Ограничение - WiFi работает очень медленно.

# 4. Solution #

Буферизированная синхронизация данных юзеров с рабочих машин на сервер с помощью rsync.
  1. быстрый этап - на локальный том (в начале работы) - полная синхронизация;
  1. медленный - с локального тома на сервер - без удаления dest и с ограничением bandwidth.

Для избежания конфликтов:
  * залогиниться нельзя, пока не отработает этап #1
  * этап #2 - в фоне, рутом
  * использовать lock-файлы

# 5. Prepare #

## 5.1. Domain ##
  1. Сделать матрицу Группы/Пользователи
  1. Убрать у Пользователей и/или Групп небезопасные права (типа Администратор, Debug User etc)
  1. Прописать в профилях дефолтные папки "Мои документы" и "Рабочий стол" в D:\Data\%USERNAME%{Dox|Desktop}

## 5.2. FileServer ##
  1. Сделать шары:
    * Папка обмена (можно с еженощной зачисткой)
    * Архив документов (RO)
    * Файлопомойка
    * Общие документы

## 5.3. Workstations ##
  1. Зачистка:
    1. Слить все данные всех неработающих Пользователей на сервер.
    1. Слить все инсталяции в файлопомойку
    1. Все программы должны быть (пере)установлены на C:\
    1. Удалить всех локальных Пользователей
    1. Удалить все неиспользуемые профили
  1. Ограничение:
    1. Права на D: - как на C: - Пользователям - только чтение и выполнение
    1. Завести папку D:\Data (Пользователям - создание etc)
    1. в ней - для живых Пользователей - папки %USERNAME/{Dox/Desktop} - с ними как владельцы
    1. Разбить том D: на 2 тома пополам. Второй будет под "буфер" для rsync
    1. Установить [cwRsync](http://www.itefix.no/i2/download) (клиент)
    1. Закрыть USB на запись (типа DeviceLock)
    1. Закрыть CD/DVD-RW на запись
    1. Удалить все шары

## 5.4. User ##
  1. Перекинуть всё из "Мои документы" и "Рабочий стол" в D:\Data\%USERNAME%{Dox|Desktop}
  1. Прописать "Мои документы" и "Рабочий стол" в D:\Data\%USERNAME%{Dox|Desktop}
  1. Перелогиниться
  1. проверить работу всех программ с этими правами

# 5.5. DoIt #
Собственно - настройка синхронизации.
Проблема в том, чтобы юзер не видел ни локального буфера - ни конечного бэкапа.
Вывод: всё надо делать рутом.
  1. Этап #1 - быстрая локальная синхронизация
    1. на буфер - убрать права юзерам - все
    1. Назначенные задания > При загрузке компьютера (или "При входе в windows"?)
    1. common.cmd:
```
@ECHO OFF
SET CWRSYNCHOME=%PROGRAMFILES%\CWRSYNC
SET CYGWIN=nontsec
SET HOME=%HOMEDRIVE%%HOMEPATH%
SET CWOLDPATH=%PATH%
```
    1. local.cmd:
```
@ECHO OFF
CALL common.cmd
SETLOCAL
SET PATH=%CWRSYNCHOME%\BIN;%PATH%
rsync -r -t --delete /cygdrive/c/temp/src/ /cygdrive/c/temp/dst/
```
  1. Этап #2 - медленная синхронизация с сервером. Под рутом, по крону, с локами
```
2B continued: see %COMPUTERNAME%/%USERNAME%
```