#summary Anti3141593 - Anti-delete project.

= Introduction =

Микро-проект для противодействия удалению рабочих файлов увольняющимися сотрудниками.

= Details =
  * Небольшая сеть (15 машин Windows)
  * LAN via WiFi
  * Домен на AD
  * Профили - локально

= Task =

Сделать так, чтобы увольняющиеся сотрудники не могли безвозвратно уничтожить данные. Ограничение - WiFi работает очень медленно.

= Solution =

Буферизированная синхронизация данных юзеров с рабочих машин на сервер с помощью rsync.
  # быстрый этап - на локальный том (в начале работы) - полная синхронизация;
  # медленный - с локального тома на сервер - без удаления dest и с ограничением bandwidth.

Для избежания конфликтов:
  * залогиниться нельзя, пока не отработает этап #1
  * этап #2 - в фоне, рутом
  * использовать lock-файлы

= Prepare =

== Domain ==
  # Сделать матрицу Группы/Пользователи
  # Убрать у Пользователей и/или Групп небезопасные права (типа Администратор, Debug User etc)
  # Прописать в профилях дефолтные папки "Мои документы" и "Рабочий стол" в D:\Data\%USERNAME%{Dox|Desktop}

== FileServer ==
  # Сделать шары:
    * Папка обмена (можно с еженощной зачисткой)
    * Архив документов (RO)
    * Файлопомойка
    * Общие документы

== Workstations ==
  # Зачистка:
    # Слить все данные всех неработающих Пользователей на сервер.
    # Слить все инсталяции в файлопомойку
    # Все программы должны быть (пере)установлены на C:\
    # Удалить всех локальных Пользователей
    # Удалить все неиспользуемые профили
  # Ограничение:
    # Права на D: - как на C: - Пользователям - только чтение и выполнение
    # Завести папку D:\Data (Пользователям - создание etc)
    # в ней - для живых Пользователей - папки %USERNAME/{Dox/Desktop} - с ними как владельцы
    # Разбить том D: на 2 тома пополам. Второй будет под "буфер" для rsync
    # Установить [http://www.itefix.no/i2/download cwRsync] (клиент)
    # Закрыть USB на запись (типа DeviceLock)
    # Закрыть CD/DVD-RW на запись
    # Удалить все шары

== User ==
  # Перекинуть всё из "Мои документы" и "Рабочий стол" в D:\Data\%USERNAME%{Dox|Desktop}
  # Прописать "Мои документы" и "Рабочий стол" в D:\Data\%USERNAME%{Dox|Desktop}
  # Перелогиниться

= DoIt =
Собственно - настройка синхронизации.
Проблема в том, чтобы юзер не видел ни локального буфера - ни конечного бэкапа.
Вывод: всё надо делать рутом.
  # Этап #1 - быстрая локальная синхронизация
    # на буфер - убрать права юзерам - все
    # Назначенные задания > При загрузке компьютера (или "При входе в windows"?)
    # common.cmd: {{{
@ECHO OFF
SET CWRSYNCHOME=%PROGRAMFILES%\CWRSYNC
SET CYGWIN=nontsec
SET HOME=%HOMEDRIVE%%HOMEPATH%
SET CWOLDPATH=%PATH%
}}}
    # local.cmd: {{{
@ECHO OFF
CALL common.cmd
SETLOCAL
SET PATH=%CWRSYNCHOME%\BIN;%PATH%
rsync -r -t --delete /cygdrive/c/temp/src/ /cygdrive/c/temp/dst/
}}}
  # Этап #2 - медленная синхронизация с сервером. Под рутом, по крону, с локами
    # %COMPUTERNAME%/%USERNAME%